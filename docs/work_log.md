# 工作日志

## 2026-02-25

- 已按修复计划先补充测试用例，覆盖 MU 反弹方向、GAE done-mask、MAPPO critic 状态一致性、`torch.load` 兼容回退。
- 用户要求已确认：依赖安装与测试执行均在项目虚拟环境中进行，不使用系统 Python 直接安装。
- 已创建项目虚拟环境 `.venv`，并在其中安装依赖与 `pytest`。
- 已先执行新增/修改测试并观察到预期失败：
  - `test_mu_direction_bounce_on_y_boundary` 失败（对应 MU 上下边界反弹方向问题）。
  - `test_mlp_critic_uses_buffered_state` 失败（对应 MLP critic 状态未入 buffer）。
  - 两个 checkpoint 兼容测试报错（对应 `torch.load` 无 `weights_only` 回退逻辑）。
- 已完成代码修复：
  - `environment.py`：MU x/y 边界反弹方向分别处理。
  - `buffer.py` + `mappo.py`：rollout 增加全局 `state` 存储与读取，MLP critic 训练使用 buffer state，并加一致性校验。
  - `mappo.py` + `maddpg.py`：`torch.load` 增加 `weights_only=True` 优先加载及 `TypeError` 回退。
  - `networks.py`：`GaussianActor` 逆 sigmoid 改为 `torch.logit(cont_action.clamp(...))`。
  - `requirements.txt`：补充主版本上限约束。
- 回归结果（均在 `.venv`）：
  - `python -m unittest discover -s tests -p "test_*.py" -v`：12/12 通过。
  - `python -m pytest -q`：12/12 通过。
- 已按新依赖上限重新执行 `python -m pip install -r requirements.txt`，`numpy` 已从 `2.4.2` 降级至 `1.26.4`，并再次通过 `unittest` 全量回归（12/12）。
- 第二轮“剩余问题”修复已开始，先新增测试并确认失败（TDD 红灯）：
  - `RunningMeanStd` 向量奖励输入时计数按步更新（此前 `count` 按元素数量累计）。
  - 环境批量速率 API `compute_mu_uav_rate_batch`（此前不存在）。
  - 环境实例级随机数（`seed`/`rng`）与可复现 reset（此前 `UAVMECEnv.__init__` 不支持 `seed`）。
  - 碰撞惩罚向量化接口 `_collision_penalties`（此前不存在）。
  - `step()` 对边缘卸载路径使用批量速率 API（此前仍走逐个 MU 的标量 API）。
- 第二轮代码修复内容：
  - `channel_model.py`：新增 `compute_mu_uav_rate_batch` 并做输入形状校验。
  - `environment.py`：
    - 引入 `seed`/`rng`，内部随机采样统一使用实例 `self.rng`。
    - `_get_observations` 改为向量化构建（减少 K×M 双层循环）。
    - 新增 `_collision_penalties` 并让 `_penalty_collision` 复用。
    - `step` 的能量/时延主路径改为批量计算，调用 `compute_mu_uav_rate_batch`。
  - `mappo.py`：`RunningMeanStd.update` 改为按时间步计数（每次更新 `count += 1`）。
  - `train.py`：创建环境时传入 `seed=args.seed`，使环境随机流与训练种子显式绑定。
  - `maddpg.py` + `config.py`：补充 warmup 单位说明（transition 级别，非 episode）。
  - `tests/test_environment_metrics.py`：边界反弹测试改为注入实例 `rng`，兼容新随机数架构。
  - 新增测试：`test_running_mean_std_remaining.py`、`test_channel_model_batch_rate.py`、`test_environment_remaining.py`。
- 第二轮回归结果（均在 `.venv`）：
  - `python -m unittest discover -s tests -p "test_*.py" -v`：17/17 通过。
  - `python -m pytest -q`：17/17 通过。

- 第三轮（出图脚本问题修复）按计划完成：
  - `generate_figures.py`
    - 新增 `--allow-missing`（默认严格缺失失败）与 `--fig13-seed`（Fig13 可复现）。
    - `main()` 增加目标图所需输入文件校验：缺失时默认 `SystemExit(2)`，传 `--allow-missing` 才按图 `skip`。
    - Fig10/Fig11 的 `K=...` 系列改为数值排序，避免 `K=100` 被排在 `K=60` 前面。
    - Fig13 启发式轨迹改为确定性随机流：`_run_heuristic_trajectory(..., seed=...)`，并为每个子图使用 `base_seed + idx`。
  - `run_all.py`
    - 新增 `--full-device`（默认 `cpu`）。
    - `full` 阶段命令显式注入 `--device <full-device>`，降低并行 GPU OOM 风险。
    - 提取 `_build_full_cmd()` 便于测试与复用。
  - `train_sweep.py`
    - `_aggregate_history()` 改为 `with np.load(...)` 上下文管理，避免 `NpzFile` 句柄滞留。

- 第三轮新增测试（先失败后修复）：
  - `tests/test_generate_figures_strict_mode.py`
  - `tests/test_generate_figures_fig13_determinism.py`
  - `tests/test_generate_figures_sorting.py`
  - `tests/test_run_all_full_device.py`
  - `tests/test_train_sweep_aggregate_history.py`

- 第三轮回归与验收（均在 `.venv`）：
  - `python -m unittest discover -s tests -p "test_*.py" -v`：26/26 通过。
  - `python -m pytest -q`：26 passed。
  - `python generate_figures.py --figs all`：在当前实验数据完整时成功出图（0 退出）。
  - `python generate_figures.py --figs all --exp_root <empty> --output_dir <tmp>`：严格模式缺输入时按预期返回 2。
  - `python generate_figures.py --figs all --exp_root <empty> --output_dir <tmp> --allow-missing`：按预期 0 退出并 `skip`。
  - `python generate_figures.py --figs 13 --fig13-seed 20260225` 连续两次 MD5 一致，确认 Fig13 可复现。

- 第四轮（Colab 兼容性与收尾检查）完成：
  - 修复 `tests/test_generate_figures_strict_mode.py` 的仓库绝对路径硬编码，改为 `Path(__file__).resolve().parents[1]` 动态定位仓库根目录，提升跨机器/CI/Colab 可移植性。
  - `generate_figures.py` 新增 `MPLCONFIGDIR` 自动初始化：
    - 新增 `_ensure_writable_mplconfigdir(candidates=None)`，若用户已设置 `MPLCONFIGDIR` 则保持不变；
    - 若未设置，优先尝试 `tempfile.gettempdir()/ab_mappo_mplconfig`，失败再回退 `os.getcwd()/.mplconfig`；
    - 通过创建目录并写入探针文件验证可写性；
    - 两个候选均失败时仅回退原行为，不中断出图流程。
  - 新增回归测试 `tests/test_generate_figures_mplconfig.py`：
    - 验证未设置 `MPLCONFIGDIR` 时可自动设置到可写目录；
    - 验证已设置 `MPLCONFIGDIR` 时不会被覆盖。

- 第四轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_generate_figures_mplconfig -v`：先红后绿（新增函数前失败，实装后通过）。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：28/28 通过。
  - `./.venv/bin/python -m pytest -q`：28 passed。
  - `./.venv/bin/python generate_figures.py --figs all --exp_root <empty_dir> --output_dir <tmp_out>`：返回码 2（严格模式符合预期）。
  - `./.venv/bin/python generate_figures.py --figs all --allow-missing --exp_root <empty_dir> --output_dir <tmp_out>`：返回码 0，且日志含 `[skip]`。
  - `HOME=<只读目录> MPLCONFIGDIR='' ./.venv/bin/python generate_figures.py --figs 13 --exp_root <empty_dir> --output_dir <tmp_out>`：返回码 0，且无 `~/.matplotlib` 不可写告警。

- 第五轮（并行稳定性修复）完成：
  - `run_all.py` 并行执行器从 `ThreadPoolExecutor + subprocess.run` 改为显式 `subprocess.Popen` 调度，修复失败场景下无法快速止损的问题。
  - 新增 fail-fast 机制：任一并行子任务非零退出时，立即终止其余运行中的子任务并抛错返回。
  - 新增单任务超时控制：
    - CLI 参数 `--job-timeout-sec`（默认 `0`，表示禁用超时）；
    - 超时后终止该任务并清理其它活动任务。
  - 修复并发日志覆盖风险：
    - 每次 `run_all.py --stage full` 运行创建独立日志目录 `run_logs/full_<timestamp>_<pid>_<uuid>/`；
    - 避免多次并行运行互相覆盖 `full_fig*.log`。
  - 新增辅助函数：
    - `_build_full_log_dir`、`_run_parallel_commands`、`_spawn_logged_process`、`_terminate_job` 等，增强可测试性与资源清理完整性。

- 第五轮新增测试：
  - `tests/test_run_all_parallel_stability.py`
    - `test_build_full_log_dir_is_unique`
    - `test_fail_fast_terminates_other_jobs`
    - `test_job_timeout_raises_error`

- 第五轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_run_all_full_device tests.test_run_all_parallel_stability -v`：5/5 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：31/31 通过。
  - `./.venv/bin/python -m pytest -q`：31 passed。
  - `./.venv/bin/python run_all.py --help`：确认新增参数 `--job-timeout-sec` 已生效。

- 第六轮（并行吞吐 P0 修复）完成：
  - `train_sweep.py`：
    - 新增 `build_run_specs(fig, options)`，统一生成 `base/6/7/8/9/10/11/12` 全量 run 规格（`dict` 结构）。
    - run 规格字段包含 `fig/algorithm/setting_name/seed/run_dir/summary_path/cli_overrides/num_mus/num_uavs`，供外部调度器直接消费。
  - `run_all.py`：
    - `run_full` 从 fig 级并行改为全局 run 级并行，按 `num_mus * num_uavs` 降序提交任务，减少尾部拖慢。
    - 新增自动线程预算注入：`OMP_NUM_THREADS/MKL_NUM_THREADS/OPENBLAS_NUM_THREADS/NUMEXPR_NUM_THREADS`。
    - 并行度规则改为：`full-device` 包含 `cuda` 时强制 `effective_parallel=1`，否则使用 `max_parallel`。
    - 训练结束后追加一次 `train_sweep.py --fig all --resume --skip_existing` 聚合，再执行 `generate_figures.py --figs all`。
  - 新增测试：
    - `tests/test_train_sweep_run_specs.py`：校验 full run 总数 `555`，并抽查 `fig10=108`、`fig11=72`。
    - `tests/test_run_all_run_level.py`：校验 run 级 job 数量、CUDA 单并行限制、线程预算环境注入。

- 第七轮（训练侧计算路径优化）完成：
  - `mappo.py`：
    - `get_values`（Attention 分支）改为纯 `torch` 路径，使用 `F.pad + torch.cat` 构建 critic 输入，移除 `_build_attention_input` 的 `numpy` 临时拼接与额外拷贝。
    - `update` 在 epoch 循环外预构建 `all_obs_t/all_ret_t`，Attention critic 更新阶段不再重复申请 `torch.zeros` 与重复拼接返回目标。
  - `networks.py`：
    - `AttentionCritic.forward` 优先使用 `torch.nn.functional.scaled_dot_product_attention`；
    - 对旧版 torch 自动回退到原手写 `matmul + softmax`，保持兼容性；
    - 清理不再使用的 `numpy` 依赖导入。

- 第七轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m py_compile mappo.py networks.py`：通过。
  - `./.venv/bin/python -m unittest tests.test_mappo_critic_state_consistency tests.test_networks_stability -v`：2/2 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：35/35 通过。
  - `./.venv/bin/python -m pytest -q`：35 passed。

- 第八轮（定向修复 #3/#2/#8 + 语义注释）完成：
  - `environment.py`
    - `_apply_wo_dt_noise()` 补齐 MU `task_data` 字段噪声注入（此前仅对 `task_cpu` 加噪声）。
    - 在 UAV 奖励中补充注释，说明扣减关联 MU 能量/时延属于协同 shaping 设计，若需严格论文拆解可后续参数化。
  - `buffer.py`
    - `RolloutBuffer.add()` 增加越界保护：当 `pos >= buffer_size` 时主动抛出 `RuntimeError`，错误信息包含 `overflow` 与 `reset` 提示。
  - `bench_parallel.py` / `benchmark_device.py`
    - 顶层执行逻辑下沉到 `main()`，并增加 `if __name__ == "__main__": main()` 守护；
    - 导入模块不再触发 benchmark 训练子进程。
  - `mappo.py`
    - 补充设计意图注释：联合 advantage 归一化是 baseline 选择；
    - MLP critic 标量 value 广播到各 agent 是有意的 centralized scalar 设计。

- 第八轮新增测试：
  - `tests/test_buffer_overflow_guard.py`
  - `tests/test_environment_wo_dt_task_data_noise.py`
  - `tests/test_benchmark_main_guard.py`

- 第八轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_buffer_overflow_guard tests.test_environment_wo_dt_task_data_noise tests.test_benchmark_main_guard -v`：4/4 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：39/39 通过。
  - `./.venv/bin/python -m pytest -q`：39 passed。

- 第九轮（8 项性能优化全量落地）完成：
  - `mappo.py`
    - 新增 `_obs_to_tensors` / `_actions_from_tensors` / `_values_from_tensors` / `get_actions_and_values`，将每步动作与价值估计复用同一份观测 tensor。
    - `get_actions` 改为 `torch.as_tensor(..., device=...)` 路径，去除 `FloatTensor(...).to(...)` 的重复拷贝。
    - `get_values` 在 MLP critic 分支直接走 state value 计算，不再构建无用的 obs tensor。
    - `collect_episode` 改用融合接口，移除 `get_actions + get_values` 双调用。
    - `collect_episode` 统计改为循环内累计，替代多次 list comprehension 二次遍历。
  - `buffer.py`
    - `RolloutBuffer.get_batches` 全量 batch 路径改为切片视图 + `torch.from_numpy` 零拷贝。
    - 子采样路径保留随机索引行为，返回结构不变。
  - `environment.py`
    - `np.add.at` 改为 `np.bincount` 聚合 UAV 计算能耗。
    - 新增 `_penalty_distance_from_assoc`，在 `step` 中预计算 `assoc_mus_list` 复用，消除重复 `np.where` 扫描。
    - `_apply_wo_dt_noise` 的 UAV per-MU 噪声改为 reshape 向量化。
    - `_get_observations` 中 `other_uav` 构造改为掩码向量化。
  - 新增测试：
    - `tests/test_buffer_get_batches_zero_copy.py`
    - `tests/test_mappo_fused_actions_values.py`
    - `tests/test_environment_vectorized_paths.py`

- 第九轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_buffer_get_batches_zero_copy tests.test_mappo_fused_actions_values tests.test_environment_vectorized_paths -v`：5/5 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：44/44 通过。
  - `./.venv/bin/python -m pytest -q`：44 passed。
  - 轻量性能验收（CPU，2400 steps，3 次）：
    - 命令：`OMP_NUM_THREADS=1 MKL_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 NUMEXPR_NUM_THREADS=1 ./.venv/bin/python train.py --algorithm AB-MAPPO --num_mus 60 --num_uavs 10 --total_steps 2400 --episode_length 300 --device cpu --seed 42 --disable_tensorboard --run_dir /tmp/ab_mappo_perf_cpu_<i>`
    - 末轮 `eps/s`：`0.62 / 0.61 / 0.62`，中位数 `0.62`。
  - 轻量性能验收（CUDA）：
    - 同参数 `--device cuda` 运行失败，报错 `AssertionError: Torch not compiled with CUDA enabled`（当前 `.venv` 为 CPU 版 PyTorch）。

- 第十轮（针对审核剩余点的性能收尾）完成：
  - `environment.py`
    - 将 `assoc_mus_list` 提前到资源分配阶段构建，资源分配与奖励阶段共用，避免对 `association` 的重复扫描。
    - 去除 `l_all/c_all` 的冗余 `astype(np.float32)` 副本，直接复用 `self.task_data/self.task_cpu`。
    - `mu_obs` 中 UAV 位置填充由 `np.tile` 改为广播赋值，减少额外分配。
  - `mappo.py`
    - `_values_from_state` 新增可选 `state` 参数，MLP critic 路径可复用 `collect_episode` 已计算状态。
    - `get_actions_and_values(..., state=...)` 支持传入预计算 state；`collect_episode` 传入每步 state，避免每步重复 `env.get_state()` 拼接。
    - 清理 `update()` 中未使用的 `mu_ret` 变量。
  - `buffer.py`
    - `compute_gae` 改为预计算 `non_terminal/next_values/delta`，移除循环内 `if t == size-1` 分支，保持递推语义不变。
  - 新增测试：
    - `tests/test_mappo_fused_actions_values.py` 新增用例：验证 MLP 路径每步只调用一次 `get_state`（外加 rollout 末尾 bootstrap 一次）。

- 第十轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_mappo_fused_actions_values tests.test_environment_vectorized_paths tests.test_buffer_gae_done_mask tests.test_environment_remaining -v`：8/8 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：45/45 通过。
  - `./.venv/bin/python -m pytest -q`：45 passed。

- 第十一轮（性能残余问题修复）完成：
  - `mappo.py`
    - `collect_episode` 中 `state = self.env.get_state().copy()` 改为 `state = self.env.get_state()`，去除冗余拷贝。
  - `environment.py`
    - `_get_observations` 中位置归一化改为单次广播分配：`mu_pos_norm/uav_pos_norm` 由 `self.*_positions / norm_xy` 直接计算。
    - `_get_observations` 中移除 `per_mu` 中间数组，改为直接写入 `uav_obs` 切片 reshape 视图。
    - `other_uav` 构建去除 `np.tile`，改用 `mask` 的列索引重排（`j = np.where(mask)[1]`）形成 off-diagonal 视图。
    - UAV 奖励 cooperative 惩罚改为 `np.bincount` 向量化（`mu_energy_sum_per_uav + latency_sum_per_uav` 后除 `n_assoc_per_uav`），循环内仅保留边界/距离/碰撞项扣减。
    - `get_state()` 中缓存 `w/h`，避免重复 `max(self.area_width/height, 1.0)`。
  - `tests`
    - `tests/test_mappo_fused_actions_values.py`：新增/调整 `test_collect_episode_state_without_copy_semantics`。
    - `tests/test_environment_vectorized_paths.py`：新增 `test_cooperative_penalty_vector_matches_loop_reference`，验证向量化与循环参考一致。

- 第十一轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_mappo_fused_actions_values tests.test_environment_vectorized_paths -v`：5/5 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：46/46 通过。
  - `./.venv/bin/python -m pytest -q`：46 passed。
  - 轻量性能验收（CPU，2400 steps，3 次）：
    - 命令：`OMP_NUM_THREADS=1 MKL_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 NUMEXPR_NUM_THREADS=1 ./.venv/bin/python train.py --algorithm AB-MAPPO --num_mus 60 --num_uavs 10 --total_steps 2400 --episode_length 300 --device cpu --seed 42 --disable_tensorboard --run_dir /tmp/ab_mappo_perf11_cpu_<i>`
    - 末轮 `eps/s`：`0.62 / 0.61 / 0.62`，中位数 `0.62`（不低于当前基线）。

- 第十二轮（性能残余补强）完成：
  - `mappo.py`
    - `update()` 与 critic 更新中 `optimizer.zero_grad(set_to_none=True)` 全量启用（MU actor / UAV actor / critic）。
  - `environment.py`
    - 在 `__init__` 缓存常量：
      - `_norm_xy`、`_task_data_scale`、`_task_cpu_scale`、`_edge_load_scale`、
      - `_dist_penalty_scale`、`_uav_velocity_scale`、
      - `_other_uav_col_idx`（M>1 时）。
    - `_penalty_distance_from_assoc` 使用 `_dist_penalty_scale`，避免每次重算比例常量。
    - `_get_observations` 使用缓存 scale：
      - `task_data_norm/task_cpu_norm` 改为 float32 乘法（去 `astype`）；
      - `prev_edge_load` 归一化改为乘 `_edge_load_scale`；
      - `other_uav` 直接用 `_other_uav_col_idx` 重排（不再每步构造 mask/index）。
    - UAV 奖励段中将 `boundary_penalties` 与 `collision_penalties` 提到循环外向量减法；
      循环仅保留 distance penalty 的逐 UAV 扣减。
    - `get_state()` 改为复用缓存 scale，并保持原状态向量顺序不变。
  - `tests`
    - `tests/test_mappo_fused_actions_values.py` 新增
      `test_update_uses_set_to_none_for_zero_grad`。
    - `tests/test_environment_vectorized_paths.py` 新增
      `test_get_state_matches_reference_formula`，确保状态公式与旧实现一致。

- 第十二轮回归与验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_mappo_fused_actions_values tests.test_environment_vectorized_paths -v`：7/7 通过。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：48/48 通过。
  - `./.venv/bin/python -m pytest -q`：48 passed。

- 第十三轮（全面审查后问题收敛修复）完成：
  - `bench_parallel.py`
    - `run_parallel()` 将子进程等待从 `wait()` 改为 `communicate()`，避免 `stdout/stderr=PIPE` 场景的潜在阻塞。
    - 增加子进程返回码检查，任一并行任务失败即抛 `RuntimeError` 并带错误摘要。
    - 修正文档注释中的步数描述（实际 `STEPS=600`）。
  - `benchmark_device.py`
    - `run_parallel()` 同步改为 `communicate()` + 返回码校验，避免 silent failure。
    - `main()` 选择“最快方案”时只在 `rc==0` 的成功结果里比较耗时；若全失败则显式报错。
  - `mappo.py`
    - `RunningMeanStd.update()` 保持“每时间步一个样本”语义，`batch_count=1` 时将 `batch_var` 改为 `0.0`，避免跨 agent 方差注入。
    - MLP critic 中 `torch.allclose(mu_states, uav_states)` 改为默认关闭，仅在环境变量 `ABMAPPO_STRICT_STATE_CHECK=1/true/yes` 时启用，减少 CUDA 同步开销。

- 第十三轮测试补充与回归：
  - 更新 `tests/test_benchmark_main_guard.py`：
    - 新增并行 benchmark 子进程 `communicate`/返回码处理测试；
    - 新增 `benchmark_device` 仅在成功结果中选 best 的测试。
  - 更新 `tests/test_mappo_fused_actions_values.py`：
    - 新增 `test_mlp_update_does_not_require_allclose_by_default`，确保默认不触发全量 `allclose` 同步校验。
  - 更新 `tests/test_running_mean_std_remaining.py`：
    - 新增 `test_vector_reward_step_update_ignores_cross_agent_variance`，覆盖每步统计语义。

- 第十三轮验收（均在 `.venv`）：
  - `./.venv/bin/python -m unittest tests.test_benchmark_main_guard tests.test_mappo_fused_actions_values tests.test_running_mean_std_remaining -v`：11/11 通过（先红后绿完成 TDD）。
  - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：53/53 通过。
  - `./.venv/bin/python -m pytest -q`：53 passed。

- 第十四轮（发烧级性能优化落地：JIT/缓存/AMP/Compile）完成：
  - `channel_model.py`
    - 新增可选 Numba JIT 批量速率核 `_compute_mu_uav_rate_batch_jit`（`njit(cache=True, fastmath=True)`）。
    - `compute_mu_uav_rate_batch()` 保持原接口，优先走 JIT，缺失 numba 时自动回退 numpy 路径（不影响可运行性）。
  - `buffer.py`
    - 新增可选高性能 GAE 实现入口：`_compute_gae_numba`（可用时）与 `_compute_gae_numpy`（回退）。
    - `RolloutBuffer.__init__` 增加 `self._compute_gae_impl` 动态绑定。
    - `compute_gae()` 改为统一调用 `_compute_gae_impl`，保持 done-mask 语义不变。
  - `environment.py`
    - 在 `__init__` 新增 `step()` 热路径预分配缓存：
      `_bw_alloc_cache/_cpu_alloc_cache/_edge_load_cache/_t_loc_cache/_e_loc_cache/_mu_energy_cache/_t_edge_cache/_uav_comp_cache/_uav_total_cache/_latency_penalty_cache/_mu_rewards_cache/_uav_rewards_cache`。
    - `step()` 中资源分配、时延/能耗、奖励计算切换为缓存复用（`.fill(0)` + 原地写入）。
    - 修复缓存复用下的状态一致性：
      `self.prev_edge_load[:] = edge_load`（避免与 cache alias），`self.prev_offload_ratio[:] = offload_ratio`。
    - 为避免外部引用被下一步覆盖，`info` 与 `rewards` 中数组字段在返回时 `copy()`。
  - `mappo.py`
    - 新增 AMP 基础设施：
      - `self.use_amp`（仅 CUDA 启用）
      - `self.scaler`（`torch.amp.GradScaler`，旧接口回退兼容）
      - `_autocast_ctx()` 统一上下文（CPU 为 `nullcontext`）
    - `update()` 中 MU/UAV actor 与 critic 更新接入 autocast + GradScaler：
      `scale(loss).backward()` → `unscale_` → 梯度裁剪 → `scaler.step(...)`。
    - 每个 PPO epoch 末调用 `self.scaler.update()`。
    - CUDA + 非 Windows 下对 critic 启用 `torch.compile`（失败自动回退，不阻塞训练）。
  - `requirements.txt`
    - 新增 `numba>=0.57.0,<1.0`（用于启用上述 JIT 路径）。

- 第十四轮新增测试（TDD 先红后绿）：
  - `tests/test_performance_runtime_features.py`
    - `test_environment_has_preallocated_step_caches`
    - `test_environment_prev_edge_load_not_aliased_to_step_cache`
    - `test_mappo_has_amp_scaler`
    - `test_rollout_buffer_has_fast_gae_path`

- 第十四轮验收（均在 `.venv`）：
  - 定向：`./.venv/bin/python -m unittest tests.test_performance_runtime_features tests.test_buffer_gae_done_mask tests.test_channel_model_batch_rate tests.test_mappo_fused_actions_values tests.test_environment_vectorized_paths -v`：14/14 通过。
  - 全量：`./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：57/57 通过。
  - 全量：`./.venv/bin/python -m pytest -q`：57 passed。
  - 运行确认（本机 CPU 短基准，2400 steps）：
    - `AB-MAPPO` 末轮 `eps/s`：`0.60 / 0.61`。
    - 当前 `.venv` 下 `numba_jit_enabled=False`（未安装 numba，自动回退 numpy 路径，功能正常）。

- 第十五轮（RunAll CUDA 自适应并行 + OOM 退避）完成：
  - `run_all.py`
    - 新增 CUDA 并行估算常量：
      - `CUDA_PARALLEL_HARD_CAP=8`
      - `CUDA_RESERVE_GB=2.0`
      - `CUDA_MEM_PER_JOB_GB=1.6`
    - 新增 `_estimate_cuda_parallel(max_parallel, full_device)`：
      - 使用 `torch.cuda.mem_get_info()` 读取显存空闲/总量；
      - 按 `(free_gb - reserve_gb) / mem_per_job_gb` 估算并发；
      - 与 `max_parallel`、硬上限 `8` 共同裁剪，异常时回退 `1`。
    - `_effective_parallel()` 改为 CUDA 路径调用显存估算，CPU 路径保持原逻辑。
    - 新增 OOM 检测链路：
      - `_extract_log_path` / `_read_log_tail` / `_is_cuda_oom_failure`
      - 匹配关键字：`cuda out of memory`、`cuda error: out of memory`、`cublas_status_alloc_failed`。
    - `run_full()` 增加重试循环：
      - CUDA 且命中 OOM 时按 `8 -> 4 -> 2 -> 1` 降并发重试；
      - 每次重试重新构建待跑队列，自动跳过已完成 `summary.json` 的 run。
    - `run_full()` 新增运行日志字段：
      - `gpu_free_gb`、`gpu_total_gb`、`effective_parallel`、`threads_per_proc`（含 `attempt`）。
  - `tests`
    - 更新 `tests/test_run_all_run_level.py`：
      - 删除“CUDA 强制单并行”断言；
      - 改为“CUDA 自适应并发”断言（mock 显存估算返回 8）。
    - 新增 `tests/test_run_all_cuda_adaptive.py`：
      - 高显存场景并发被 cap 到 8；
      - 低显存场景回退到 1；
      - OOM 日志场景触发降并发重试（8->4）。

- 第十五轮验收（均在 `.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_run_all_run_level tests.test_run_all_cuda_adaptive tests.test_run_all_parallel_stability -v`：9/9 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：60/60 通过。
    - `./.venv/bin/python -m pytest -q`：60 passed。

- 第十六轮（CUDA 并发估算参数上调）完成：
  - `run_all.py`
    - 将 CUDA 并发估算常量调整为更激进配置：
      - `CUDA_PARALLEL_HARD_CAP: 8 -> 16`
      - `CUDA_RESERVE_GB: 2.0 -> 1.5`
      - `CUDA_MEM_PER_JOB_GB: 1.6 -> 0.35`
    - 保持现有 OOM 自动退避逻辑不变（触发时并发减半重试）。
  - `tests`
    - `tests/test_run_all_cuda_adaptive.py`
      - 调整 hard-cap 测试输入（`max_parallel=32`），确保覆盖 cap 生效；
      - OOM 退避期望从 `8->4` 更新为 `16->8`；
      - 低显存回退用例输入调整为 `free_gb=1.8`（在新参数下稳定回退到 `1`）。
    - `tests/test_run_all_run_level.py`
      - CUDA 自适应并发断言更新为 `max_parallel=16`；
      - 线程预算断言同步更新为 `threads_per_proc=1`（`cpu_count=24` 场景）。

- 第十六轮验收（`.venv`）：
  - `./.venv/bin/python -m unittest tests.test_run_all_run_level tests.test_run_all_cuda_adaptive tests.test_run_all_parallel_stability -v`：9/9 通过。

- 第十七轮（CPU 并行调度优化：单线程 + 内存感知 + 重任务限流）完成：
  - `run_all.py`
    - CPU 路径线程策略：
      - `run_full()` 在 `full-device=cpu` 时固定 `threads_per_proc=1`，避免 NumPy/BLAS 过订阅导致的吞吐下降。
    - 内存感知并发估算：
      - 新增 `_read_mem_available_gb()` 读取 `/proc/meminfo` 的 `MemAvailable`；
      - `_estimate_cpu_parallel()` 改为按 `min(max_parallel, cpu_count, by_ram)` 估算，其中
        `by_ram = floor((MemAvailable - CPU_RAM_RESERVE_GB) / CPU_RAM_PER_JOB_GB)`。
    - 重任务（大 `K`）限流：
      - 新增 `CPU_HEAVY_MU_THRESHOLD=100`、`CPU_HEAVY_PARALLEL_HARD_CAP=12`；
      - `job_specs` 增加 `is_heavy` 元信息（`num_mus >= 100`）；
      - `_run_parallel_commands()` 新增 `heavy_parallel_limit` 调度约束，限制重任务并发槽位，轻任务可穿插执行。
    - 调度器可测试化改造：
      - 新增 `_normalize_job_spec`、`_count_active_heavy`、`_pop_next_schedulable_job`。
    - 运行日志新增 CPU 观测字段：
      - `cpu_mem_available_gb`、`heavy_parallel_limit`。
  - `tests`
    - 更新 `tests/test_run_all_run_level.py`：
      - CPU 路径断言 `threads_per_proc=1`；
      - 断言 `heavy_parallel_limit` 按新策略传入。
    - 新增 `tests/test_run_all_cpu_strategy.py`：
      - CPU 并发估算（核心上限 / 低内存回退）；
      - 重任务限流选择器行为（优先轻任务 / 全重任务阻塞返回 `None`）。

- 第十七轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_run_all_run_level tests.test_run_all_cpu_strategy tests.test_run_all_cuda_adaptive tests.test_run_all_parallel_stability -v`：13/13 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：64/64 通过。
    - `./.venv/bin/python -m pytest -q`：64 passed。

- 第十八轮（论文对齐优化阶段一 + 模块源码文档同步）完成：
  - `config.py`
    - 新增默认开关常量：
      - `UAV_OBS_MASK_MODE = "none"`
      - `NORMALIZE_REWARD = True`
  - `train.py`
    - 新增 CLI 参数：
      - `--normalize_reward {on,off}`（默认 `on`）
      - `--reward_scale <float>`（默认 `cfg.REWARD_SCALE`）
      - `--uav_obs_mask_mode {none,prev_assoc}`（默认 `none`）
    - `_build_cfg_overrides()` 新增 `REWARD_SCALE` 覆盖。
    - 训练装配链路打通：
      - 环境构造透传 `uav_obs_mask_mode`；
      - agent 构造透传 `normalize_reward`。
    - `summary.json` 新增记录字段：
      - `normalize_reward`、`reward_scale`、`uav_obs_mask_mode`。
    - `namespace_from_kwargs()` 同步新增默认字段，保证 `train_sweep`/测试入口兼容。
  - `environment.py`
    - `UAVMECEnv.__init__` 新增 `uav_obs_mask_mode`（`none/prev_assoc`）并做参数校验。
    - 新增 `self.prev_association` 状态（`shape=(K,)`）；
      - `reset()` 置零；
      - `step()` 每步写入最新 `association`。
    - `_get_observations()` 在 `prev_assoc` 模式下对 `uav_obs` 的 per-MU 区块做关联掩码：
      - 非关联 MU 的 5 维特征清零。
    - Jain 公平性指标对齐论文原式：
      - `jain_fairness = (sum(E_k)^2) / (K * sum(E_k^2) + eps)`。
    - 保留 legacy：
      - 新增 `info["jain_fairness_utility"]`（inverse-energy 版本）避免历史分析脚本断裂。
  - `networks.py`
    - `AttentionCritic` 改为异构双编码器结构：
      - `mu_encoder`（用户观测）
      - `uav_encoder`（UAV 观测）
    - 构建并注册 `attn_bias`（对角线 `-inf`）；
      - `scaled_dot_product_attention` 路径传入 `attn_mask=attn_bias`；
      - fallback 路径 `attn_scores += attn_bias` 后 `softmax`。
    - 显式实现 `j != i` 的注意力屏蔽，去除自注意力。
  - `mappo.py`
    - `ABMAPPO.__init__` 新增 `normalize_reward: bool`。
    - 注意力 critic 实例化改为传入：
      - `num_mus/num_uavs/mu_obs_dim/uav_obs_dim`。
    - `collect_episode()` 奖励路径增加兼容开关：
      - `normalize_reward=on`：保持 RMS 归一化；
      - `normalize_reward=off`：直接使用 raw reward。
  - `scripts/generate_current_modules_code.py`
    - 新增可重复生成脚本：
      - 收集仓库内非 `tests` 的 `.py`；
      - 按路径排序；
      - 生成 `docs/current_modules_code.md`。

- 第十八轮测试补充（TDD：先红后绿）：
  - 修改 `tests/test_environment_metrics.py`
    - 将 Jain 断言改为论文原式；
    - 新增 legacy 指标字段断言 `jain_fairness_utility`。
  - 新增 `tests/test_attention_critic_mask_and_encoders.py`
    - 校验 `AttentionCritic` 具备双 encoder；
    - 通过 patch SDPA 捕获并断言对角 `attn_mask` 为 `-inf`。
  - 新增 `tests/test_environment_uav_obs_mask_mode.py`
    - `prev_assoc`：非关联 MU 特征应清零；
    - `none`：保持全量 MU 特征。
  - 新增 `tests/test_train_cli_paper_flags.py`
    - 校验新 CLI 参数解析；
    - 校验 `train()` 透传参数并写入 `summary.json`。

- 第十八轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_environment_metrics tests.test_attention_critic_mask_and_encoders tests.test_environment_uav_obs_mask_mode tests.test_train_cli_paper_flags -v`：14/14 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：71/71 通过。
    - `./.venv/bin/python -m pytest -q`：71 passed。
  - 训练烟测：
    - `./.venv/bin/python train.py --algorithm AB-MAPPO --total_steps 600 --episode_length 300 --device cpu --disable_tensorboard --uav_obs_mask_mode prev_assoc --run_dir /tmp/ab_mappo_stage1_smoke_prev_assoc`：通过。
    - `./.venv/bin/python train.py --algorithm AB-MAPPO --total_steps 600 --episode_length 300 --device cpu --disable_tensorboard --normalize_reward off --reward_scale 1.0 --run_dir /tmp/ab_mappo_stage1_smoke_raw_reward`：通过。

- 第十九轮（阶段二核心功能推进：BS中继/运动学/Critic/rollout语义）完成：
  - `environment.py`
    - MU 动作离散维度扩展为 `M+2`：
      - `0`=本地计算，`1..M`=直接卸载到 UAV，`M+1`=经 UAV 中继到 BS。
    - `step()` 新增 BS 中继路径：
      - 为 `association == M+1` 的 MU 选择最近 UAV 作为 relay；
      - 计算 MU→UAV 一跳速率（`compute_mu_uav_rate_batch`）与 UAV→BS 二跳速率（`compute_uav_bs_rate`）；
      - 累加 MU 发射能耗、二跳时延、UAV 中继发射能耗；
      - 中继任务映射到 relay UAV 参与协同惩罚分摊。
    - UAV 位置更新引入论文式加速度位移项：
      - `q[n+1] = q[n] + v[n]Δt + 0.5*a[n]Δt^2`；
      - 速度仍保持最大加速度与最大速度双约束。
    - `prev_association` 更新为“有效 UAV 关联”（含 BS 中继映射到 relay UAV），与 `prev_assoc` 观测掩码语义保持一致。
  - `networks.py`
    - `MLPCritic` 输出维度由标量改为 `num_agents`（当传入 `num_agents` 时）。
  - `mappo.py`
    - `ABMAPPO` 新增 `rollout_mode`：
      - `fixed`（默认）：保持 300-step 跨 episode rollout；
      - `env_episode`：一次 rollout 仅收集单个环境 episode（`env.max_steps`）。
    - MLP critic 路径改为 per-agent value：
      - `_values_from_state()` 返回 `[K] + [M]` 独立 value；
      - `_update_mlp_critic()` 用 `cat(mu_returns, uav_returns)` 与 critic 输出逐 agent 对齐回归。
    - MU association clip / 随机策略同步适配 `M+1` 的 BS 标签。
  - `train.py`
    - 新增 CLI：`--rollout_mode {fixed,env_episode}`（默认 `fixed`）。
    - `_make_agent()` 透传 `rollout_mode`；
    - `summary.json` 新增 `rollout_mode` 字段；
    - `namespace_from_kwargs()` 新增默认 `rollout_mode`。
  - `config.py`
    - 新增 `ROLLOUT_MODE = "fixed"`。

- 第十九轮测试补充：
  - 新增 `tests/test_stage2_alignment_features.py`：
    - `test_mu_discrete_dim_includes_bs_relay_choice`
    - `test_bs_relay_path_calls_uav_bs_rate`
    - `test_mlp_critic_outputs_per_agent_values`
    - `test_env_episode_rollout_mode_collects_single_env_horizon`
  - 更新 `tests/test_train_cli_paper_flags.py`：
    - 新增 `rollout_mode` 参数解析、透传与 summary 字段断言。

- 第十九轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_stage2_alignment_features tests.test_train_cli_paper_flags tests.test_mappo_critic_state_consistency tests.test_environment_metrics tests.test_environment_remaining -v`：18/18 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：75/75 通过。
    - `./.venv/bin/python -m pytest -q`：75 passed。
  - 训练烟测：
    - `./.venv/bin/python train.py --algorithm AB-MAPPO --total_steps 600 --episode_length 300 --device cpu --disable_tensorboard --rollout_mode env_episode --run_dir /tmp/ab_mappo_stage2_env_episode`：通过。
    - `./.venv/bin/python train.py --algorithm AB-MAPPO --total_steps 600 --episode_length 300 --device cpu --disable_tensorboard --rollout_mode fixed --run_dir /tmp/ab_mappo_stage2_fixed`：通过。

- 第二十轮（实验数据体检 + 出图门禁）完成：
  - 新增 `experiment_validator.py`：
    - `validate_run_summaries(specs, total_steps, episode_length)`：
      - 检查每个期望 run 的 `summary.json` 是否存在；
      - 检查 `algorithm/seed/num_mus/num_uavs/total_steps/episode_length` 是否与 sweep 规格一致；
      - 防止“缺 run”与“参数混跑”进入出图。
    - `validate_aggregate_freshness(specs, aggregate_paths)`：
      - 以各 fig 最新 `summary.json` 修改时间为基准；
      - 检查 `aggregate/*.json` 是否存在且不早于对应 summary（防止 stale aggregate）；
      - 额外校验 aggregate JSON 可解析。
    - `validate_experiment_outputs(...)`：
      - 使用 `build_run_specs("all", ...)` 汇总期望 run；
      - 统一执行 run 完整性与 aggregate 新鲜度校验；
      - 校验失败时抛 `RuntimeError` 并列出问题清单。
  - `run_all.py`
    - 在 full 阶段聚合命令（`train_sweep.py --fig all --resume --skip_existing`）之后、
      `generate_figures.py` 之前，新增强制门禁：
      - 调用 `validate_experiment_outputs(...)`；
      - 通过后打印 `[full] experiment data validation passed`；
      - 不通过直接终止，阻止错误数据出图。
  - 测试更新：
    - 新增 `tests/test_experiment_validator.py`：
      - 覆盖缺 summary、参数不一致、aggregate 过期三类核心异常。
    - 更新 `tests/test_run_all_run_level.py`：
      - run_full 正常路径断言 `validate_experiment_outputs` 被调用；
      - 新增校验失败时“阻止 generate_figures”测试。
    - 更新 `tests/test_run_all_cuda_adaptive.py`：
      - 适配新增门禁调用（mock `validate_experiment_outputs`）。

- 第二十轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_experiment_validator tests.test_run_all_run_level tests.test_run_all_cuda_adaptive -v`：10/10 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：79/79 通过。
    - `./.venv/bin/python -m pytest -q`：79 passed。

- 第二十一轮（阶段四：BS 中继策略可配置）完成：
  - `config.py`
    - 新增默认常量：`BS_RELAY_POLICY = "nearest"`。
  - `train.py`
    - 新增 CLI 参数：`--bs_relay_policy {nearest,best_snr,min_load}`；
    - 环境构造透传 `bs_relay_policy`；
    - `summary.json` 新增 `bs_relay_policy` 字段；
    - `namespace_from_kwargs()` 增加默认项，保证测试与脚本入口兼容。
  - `environment.py`
    - `UAVMECEnv.__init__` 新增 `bs_relay_policy` 参数与合法值校验；
    - 新增 `_select_bs_relay_uav(...)`，支持三种策略：
      - `nearest`：按 MU-UAV 欧氏距离最近；
      - `best_snr`：按 MU->UAV first-hop 速率最大（等带宽评分）；
      - `min_load`：按当前有效负载最小优先、同负载按距离打破平局。
    - `step()` 中 BS 中继关联由固定“最近 UAV”改为策略选择结果，其他能耗/时延逻辑保持不变。
  - 新增测试：
    - `tests/test_bs_relay_policy.py`
      - 非法策略应抛异常；
      - `nearest` 映射正确；
      - `min_load` 能均衡分配；
      - 训练 CLI 能透传并写入 summary。

- 第二十一轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_bs_relay_policy -v`：4/4 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：83/83 通过。
    - `./.venv/bin/python -m pytest -q`：83 passed。

- 第二十二轮（下阶段：paper_mode 预设链路打通）完成：
  - 目标：
    - 将论文对齐关键开关收敛为单一 `paper_mode` 预设，减少手工参数遗漏；
    - 打通 `train.py -> train_sweep.py -> run_all.py -> experiment_validator.py` 全链路。
  - `config.py`
    - 新增默认常量：`PAPER_MODE = "off"`。
  - `train.py`
    - 新增 CLI 参数：`--paper_mode {on,off}`；
    - 新增 `_apply_paper_mode_preset(args)`：
      - `paper_mode=on` 时强制：
        - `normalize_reward=off`
        - `reward_scale=1.0`
        - `uav_obs_mask_mode=prev_assoc`
        - `rollout_mode=env_episode`
        - `bs_relay_policy=best_snr`
    - `summary.json` 新增字段：`paper_mode`；
    - `namespace_from_kwargs()` 新增默认 `paper_mode`。
  - `train_sweep.py`
    - `RunOptions` 新增字段 `paper_mode: bool = False`；
    - 新增 CLI 开关 `--paper_mode`；
    - `build_run_specs` 在 `paper_mode=True` 时自动注入 `cli_overrides["paper_mode"]="on"`。
  - `run_all.py`
    - `run_full()` 新增参数 `paper_mode=False`，并向 run 级任务构建透传；
    - `parse_args()` 新增 `--paper_mode`；
    - `_summary_matches()` 新增 paper_mode 匹配条件（开启时仅复用 `summary.paper_mode=true` 的已有 run）；
    - full 阶段聚合命令在 paper_mode 开启时自动附加 `--paper_mode`；
    - `validate_experiment_outputs()` 调用新增 `paper_mode` 透传。
  - `experiment_validator.py`
    - `validate_experiment_outputs(..., paper_mode=False)` 新增参数；
    - `paper_mode=True` 时额外校验每个 summary 的 `paper_mode` 字段必须为 true。
  - 测试更新（TDD：先红后绿）：
    - `tests/test_train_cli_paper_flags.py`
      - `parse_args` 覆盖 `--paper_mode on`；
      - 新增 `test_train_paper_mode_forces_preset_flags`。
    - `tests/test_train_sweep_run_specs.py`
      - 新增 `test_paper_mode_injects_cli_override`。
    - `tests/test_run_all_run_level.py`
      - 新增 `test_build_run_job_specs_propagates_paper_mode`。

- 第二十二轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_train_cli_paper_flags tests.test_train_sweep_run_specs tests.test_run_all_run_level -v`：10/10 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：86/86 通过。
    - `./.venv/bin/python -m pytest -q`：86 passed。

- 第二十三轮（paper_mode 字段级一致性门禁）完成：
  - 目标：
    - 在 `paper_mode` 开启时，不只校验 `summary.paper_mode=true`，还校验关键论文配置字段一致，避免“打了 paper_mode 标签但参数不一致”的混入。
  - `config.py`
    - 新增 paper profile 常量：
      - `PAPER_PROFILE_NORMALIZE_REWARD = False`
      - `PAPER_PROFILE_REWARD_SCALE = 1.0`
      - `PAPER_PROFILE_UAV_OBS_MASK_MODE = "prev_assoc"`
      - `PAPER_PROFILE_ROLLOUT_MODE = "env_episode"`
      - `PAPER_PROFILE_BS_RELAY_POLICY = "best_snr"`
  - `train.py`
    - `_apply_paper_mode_preset()` 改为引用上述 profile 常量，消除硬编码，确保训练预设与门禁预设同源。
  - `experiment_validator.py`
    - 新增 `validate_paper_profile(specs)`：
      - 在 summary 级校验：
        - `paper_mode`
        - `normalize_reward`
        - `reward_scale`（浮点容差）
        - `uav_obs_mask_mode`
        - `rollout_mode`
        - `bs_relay_policy`
    - `validate_experiment_outputs(..., paper_mode=True)` 时，新增调用 `validate_paper_profile` 并并入错误列表。
  - 测试更新（TDD：先红后绿）：
    - `tests/test_experiment_validator.py`
      - 新增 `test_validate_experiment_outputs_paper_mode_requires_profile_fields`：
        - 构造 `paper_mode=true` 但 `reward_scale` 错配样本；
        - 断言 `validate_experiment_outputs(..., paper_mode=True)` 抛错并包含 `reward_scale` 关键词。

- 第二十三轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_experiment_validator -v`：4/4 通过。
    - `./.venv/bin/python -m unittest tests.test_train_cli_paper_flags tests.test_train_sweep_run_specs tests.test_run_all_run_level -v`：10/10 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：87/87 通过。
    - `./.venv/bin/python -m pytest -q`：87 passed。

- 第二十四轮（论文审查剩余项修复：MADDPG 维度 + 中继带宽 + 语义告警）完成：
  - `maddpg.py`
    - 修复 MU association 维度：
      - `self.mu_assoc_dim: M+1 -> M+2`；
      - 与环境离散动作空间 `{0,1,...,M,M+1}` 对齐，支持 BS relay 选项。
  - `environment.py`
    - 修复 BS relay 第一跳带宽分配：
      - 原实现：relay MU 独立均分 `cfg.BANDWIDTH`；
      - 新实现：与 direct MU 共用同一 UAV 的带宽 softmax 分配池（基于 `assoc_mus_list`）。
    - 保留 CPU 分配仅针对 direct MU（relay 不在 UAV 侧计算）。
    - 增加注释澄清中继路径：
      - `uav_comp_energy` 实际累加“非飞行能耗”（direct 计算 + relay 转发发射）；
      - BS 端计算延迟在当前论文设定下按可忽略处理。
    - relay 路径变量名 `e_uav_bs` 改为 `e_uav_relay_tx`，降低误导。
  - `mappo.py`
    - 在 `_values_from_state` 的标量广播防御分支新增 `RuntimeWarning`（仅首次）：
      - 提示 critic 输出维度配置可能异常。

- 第二十四轮测试补充（TDD：先红后绿）：
  - `tests/test_stage2_alignment_features.py`
    - 新增 `test_maddpg_assoc_dim_matches_env_discrete_space`；
    - 新增 `test_bs_relay_bandwidth_shares_uav_allocator_pool`（验证 relay 带宽不再独立均分）。
  - `tests/test_mappo_fused_actions_values.py`
    - 新增 `test_values_from_state_warns_when_scalar_critic_is_broadcast`。

- 第二十四轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m unittest tests.test_stage2_alignment_features tests.test_mappo_fused_actions_values -v`：11/11 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：90/90 通过。
    - `./.venv/bin/python -m pytest -q`：90 passed。

- 第二十五轮（关键语义与训练稳定性修复）完成：
  - 目标：收敛并修复高/中优先级剩余项（UAV 能耗双计入、rollout 计步语义、value clipping、资源 softmax 温度开关）。
  - `environment.py`
    - 资源分配温度从硬编码 `*3.0` 改为配置项 `cfg.RESOURCE_SOFTMAX_TEMPERATURE`；
    - 当温度 `<=0` 时，带宽/CPU 分配退化为均匀分配（避免数值异常并支持可控实验）；
    - UAV reward 自身能耗项改为 `cfg.UAV_REWARD_SELF_ENERGY_COEFF` 控制，默认 `0.0`，避免 MU/UAV 分支对 UAV 能耗双重计入。
  - `mappo.py`
    - 新增 `_critic_value_loss(values, returns, old_values)`，支持可选 value clipping（`cfg.USE_VALUE_CLIP` / `cfg.VALUE_CLIP_EPS`）；
    - attention critic 与 MLP critic 更新路径统一接入 value clipping 损失；
    - `collect_episode()` 返回 `collected_steps`，供训练主循环按真实采样步数推进。
  - `train.py`
    - 训练主循环由“按 episode 固定步长推进”改为“按 `collected_steps` 累积到 `total_steps` 结束”；
    - 兼容未返回 `collected_steps` 的 agent（回退 `episode_length`）；
    - 日志 step 输出改为 `current/target` 格式。
  - `maddpg.py`
    - `collect_episode()` 返回 `collected_steps`（与新训练主循环语义对齐）。

- 第二十五轮测试补充（TDD：先红后绿）：
  - `tests/test_environment_metrics.py`
    - 新增 `test_uav_reward_excludes_self_energy_when_coeff_is_zero`。
  - `tests/test_mappo_fused_actions_values.py`
    - 新增 `test_critic_value_loss_uses_clipped_objective`。

- 第二十五轮验收（`.venv`）：
  - 定向：
    - `./.venv/bin/python -m pytest -q tests/test_environment_metrics.py tests/test_mappo_fused_actions_values.py tests/test_stage2_alignment_features.py tests/test_train_cli_paper_flags.py`：26/26 通过。
  - 全量：
    - `./.venv/bin/python -m unittest discover -s tests -p "test_*.py" -v`：94/94 通过。
    - `./.venv/bin/python -m pytest -q`：94 passed。
